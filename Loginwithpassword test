/**
 * @vitest-environment jsdom
 */
import React from "react";
import { render, screen, fireEvent, waitFor } from "@testing-library/react";
import { vi } from "vitest";
import axios from "axios";

// mock react-redux dispatch/selectors used inside LoginWithPassword
const mockDispatch = vi.fn();
vi.mock("react-redux", async () => {
  const actual = await vi.importActual("react-redux");
  return {
    ...actual,
    useDispatch: () => mockDispatch,
    useSelector: () => [],
  };
});

// mock react-router-dom navigate
const mockNavigate = vi.fn();
vi.mock("react-router-dom", async () => {
  const actual = await vi.importActual("react-router-dom");
  return {
    ...actual,
    useNavigate: () => mockNavigate,
  };
});

vi.mock("axios");
import LoginWithPassword from "../LoginWithPassword";

describe("LoginWithPassword (Vitest)", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("renders password field and toggles visibility", () => {
    render(<LoginWithPassword userId="1234567" openLoginErrorDialog={vi.fn()} content={{ form: {} }} />);
    const pwd = screen.getByLabelText(/Password/i);
    expect(pwd).toBeInTheDocument();

    // try to find visibility toggle button by aria-label; not mandatory if aria-label missing
    const iconBtn = screen.queryAllByRole("button").find((b) =>
      (b.getAttribute("aria-label") || "").toLowerCase().includes("show")
    );
    if (iconBtn) fireEvent.click(iconBtn);
    // after clicking, input type may change - ensure it still exists
    expect(screen.getByLabelText(/Password/i)).toBeInTheDocument();
  });

  it("submits credentials and navigates on valid response", async () => {
    axios.post.mockResolvedValueOnce({
      data: {
        validCredentials: true,
        accessToken: "fake.token",
        roleData: { root_menus: [{ route: "/dashboard" }] },
      },
    });

    render(<LoginWithPassword userId="1234567" openLoginErrorDialog={vi.fn()} content={{ form: {} }} />);

    fireEvent.change(screen.getByLabelText(/Password/i), { target: { value: "Password123!" } });

    const signBtn = screen.getByRole("button", { name: /sign in/i });
    fireEvent.click(signBtn);

    await waitFor(() => {
      expect(axios.post).toHaveBeenCalledWith("/LS/auth/login", {
        userId: "1234567",
        password: "Password123!",
      });
    });

    await waitFor(() => {
      expect(mockNavigate).toHaveBeenCalledWith("/dashboard");
    });

    expect(mockDispatch).toHaveBeenCalled();
  });

  it("shows attempts left message when invalid password with attemptsLeft", async () => {
    axios.post.mockResolvedValueOnce({
      data: {
        validCredentials: false,
        userStatus: "ACTIVE",
        loginMethod: "p",
        attemptsLeft: 2,
      },
    });

    const mockOpen = vi.fn();
    render(<LoginWithPassword userId="1234567" openLoginErrorDialog={mockOpen} content={{ form: {} }} />);

    fireEvent.change(screen.getByLabelText(/Password/i), { target: { value: "badpass" } });
    fireEvent.click(screen.getByRole("button", { name: /sign in/i }));

    await waitFor(() => expect(axios.post).toHaveBeenCalled());

    // component should set invalid message or call dialog depending on attempts; check for one of them
    expect(screen.queryByText(/Invalid password you have \d+ attempts left/i) || mockOpen).toBeTruthy();
  });
});
