// src/theme/AppTheme.jsx
import React, { useMemo, createContext, useState, useEffect } from "react";
import PropTypes from "prop-types";
import { ThemeProvider, createTheme } from "@mui/material/styles";

// named import from themePrimitives
import { colorSchemes, typography, shadows, shape } from "./themePrimitives";

// IMPORTANT: use named imports for customization files (they export named objects)
import { inputsCustomizations } from "./customizations/inputs";
import { dataDisplayCustomizations } from "./customizations/dataDisplay";
import { feedbackCustomizations } from "./customizations/feedback";
import { navigationCustomizations } from "./customizations/navigation";
import { surfacesCustomizations } from "./customizations/surfaces";

// ThemeContext for the switcher button
export const ThemeContext = createContext({
  currentTheme: "light",
  changeTheme: () => {}
});

function AppTheme(props) {
  const { children, disableCustomTheme, themeComponents } = props;
  const [currentTheme, setCurrentTheme] = useState("light");

  // load saved theme (only if valid)
  useEffect(() => {
    const saved = localStorage.getItem("app-theme");
    if (saved && Object.keys(colorSchemes).includes(saved)) {
      setCurrentTheme(saved);
    } else {
      setCurrentTheme("light");
    }
  }, []);

  // persist only valid keys
  useEffect(() => {
    if (currentTheme && Object.keys(colorSchemes).includes(currentTheme)) {
      localStorage.setItem("app-theme", currentTheme);
    }
  }, [currentTheme]);

  const changeTheme = (themeName) => {
    if (themeName && Object.keys(colorSchemes).includes(themeName)) {
      setCurrentTheme(themeName);
    } else {
      console.warn("Trying to set unknown theme:", themeName);
    }
  };

  // safe key fallback
  const safeThemeKey = Object.keys(colorSchemes).includes(currentTheme) ? currentTheme : "light";

  // debug logs (remove later)
  useEffect(() => {
    console.log("AppTheme: currentTheme =", currentTheme, "safeThemeKey =", safeThemeKey);
    console.log("Available colorSchemes keys:", Object.keys(colorSchemes));
  }, [currentTheme, safeThemeKey]);

  const theme = useMemo(() => {
    if (disableCustomTheme) return {};
    return createTheme({
      cssVarPrefix: "template",
      cssVariables: {
        colorSchemeSelector: "data-mui-color-scheme"
      },
      colorSchemes,
      defaultColorScheme: safeThemeKey,
      typography,
      shadows,
      shape,
      components: {
        ...inputsCustomizations,
        ...dataDisplayCustomizations,
        ...feedbackCustomizations,
        ...navigationCustomizations,
        ...surfacesCustomizations,
        ...themeComponents
      }
    });
  }, [disableCustomTheme, themeComponents, safeThemeKey]);

  if (disableCustomTheme) return <>{children}</>;

  return (
    <ThemeContext.Provider value={{ currentTheme, changeTheme }}>
      <ThemeProvider theme={theme} disableTransitionOnChange>
        {children}
      </ThemeProvider>
    </ThemeContext.Provider>
  );
}

AppTheme.propTypes = {
  children: PropTypes.node,
  disableCustomTheme: PropTypes.bool,
  themeComponents: PropTypes.object
};

export default AppTheme;
