import React, { useEffect, useState } from "react";
import axios from "axios";
import { Box, InputAdornment, IconButton } from "@mui/material";
import LockIcon from "@mui/icons-material/Lock";
import Visibility from "@mui/icons-material/Visibility";
import VisibilityOff from "@mui/icons-material/VisibilityOff";
import { v4 as uuidv4 } from "uuid";

import { parseJwt } from "../../../utils/EncryptionUtilities";
import { loginDialogMessages, loginDialogHeaders } from "../constants";
import { useNavigate } from "react-router-dom";
import { useDispatch, useSelector } from "react-redux";
import { setMenus, setSelectedMenuItem } from "../../../app/slices/menuSlice";
import { setTabId } from "../../../app/slices/tabsSlice";
import { setToken, setUser } from "../../../app/slices/authSlice";

import {
  StyledTextField,
  PrimaryButton,
  FormTitle,
  PasswordErrorText,
} from "./LoginStyles";

const LoginWithPassword = ({ userId, openLoginErrorDialog, onBackToHome }) => {
  const [password, setPassword] = useState("");
  const [passwordInvalidMessage, setPasswordInvalidMessage] = useState("");
  const [showPassword, setShowPassword] = useState(false);

  const navigate = useNavigate();
  const dispatch = useDispatch();
  const menusFromStore = useSelector((state) => state.menus.menus);

  // (Optional) जर Redux मध्ये menus नंतर आले तर navigate — legacy behavior ठेवतो.
  useEffect(() => {
    if (menusFromStore?.[0]?.route) navigate(menusFromStore[0].route);
  }, [menusFromStore, navigate]);

  const validateUserCredentials = async () => {
    setPasswordInvalidMessage("");

    try {
      const response = await axios.post("/LS/auth/login", {
        userId,
        password,
      });

      const result = response?.data || {};

      // === Success ===
      if (result.validCredentials === true) {
        const user = parseJwt(result.accessToken);
        const tabId = uuidv4();

        // token / user / tab
        dispatch(setTabId(tabId));
        dispatch(setToken(result.accessToken));
        dispatch(setUser(user));

        // menus (may be empty per your screenshot)
        const menus = result.roleData?.root_menus || [];
        dispatch(setMenus(menus));
        dispatch(setSelectedMenuItem(menus?.[0] ?? null));

        // Broadcast for other tabs
        try {
          const bc = new BroadcastChannel("auth");
          setTimeout(() => {
            bc.postMessage({
              type: "USER_LOGGED_IN",
              tabId,
              userId: user.userId,
            });
          }, 1000);
        } catch {
          /* ignore */
        }

        // Navigate immediately:
        // 1) first menu route if present
        // 2) backend-provided defaultRoute if present
        // 3) fallback '/dashboard' (change if your app uses another)
        const routeToNavigate =
          menus?.[0]?.route || result.roleData?.defaultRoute || "/dashboard";
        navigate(routeToNavigate);

        return true;
      }

      // === Invalid password / account locked ===
      if (result.userStatus === "ACTIVE" && result.loginMethod === "p") {
        if (typeof result.attemptsLeft === "number" && result.attemptsLeft > 0) {
          setPasswordInvalidMessage(
            `Invalid password. You have ${result.attemptsLeft} attempts left.`
          );
        } else {
          openLoginErrorDialog(
            "Account Locked",
            "You are out of attempts and your account has been locked."
          );
        }
        return false;
      }

      // === Other statuses (use your header/message maps) ===
      openLoginErrorDialog(
        loginDialogHeaders[result.userStatus] || "Login Error",
        loginDialogMessages[result.userStatus] || "Something went wrong"
      );
      return false;
    } catch (err) {
      console.error("[login] request failed:", err);
      openLoginErrorDialog(
        "Login Failed",
        err?.response?.data?.message || "Failed to log into FinCore, please try again later"
      );
      return false;
    }
  };

  const toggleShowPassword = () => setShowPassword((s) => !s);

  return (
    <Box>
      <FormTitle>Enter Password</FormTitle>

      <StyledTextField
        fullWidth
        label="Password"
        type={showPassword ? "text" : "password"}
        placeholder="Enter your password"
        value={password}
        onChange={(e) => setPassword(e.target.value)}
        variant="outlined"
        error={passwordInvalidMessage !== ""}
        margin="normal"
        InputProps={{
          startAdornment: (
            <InputAdornment position="start">
              <LockIcon />
            </InputAdornment>
          ),
          endAdornment: (
            <InputAdornment position="end">
              <IconButton
                aria-label={showPassword ? "Hide password" : "Show password"}
                onClick={toggleShowPassword}
                edge="end"
              >
                {showPassword ? <VisibilityOff /> : <Visibility />}
              </IconButton>
            </InputAdornment>
          ),
        }}
      />

      {passwordInvalidMessage && (
        <PasswordErrorText>{passwordInvalidMessage}</PasswordErrorText>
      )}

      <PrimaryButton
        fullWidth
        variant="contained"
        onClick={validateUserCredentials}
        disabled={!userId}
      >
        Sign In
      </PrimaryButton>
    </Box>
  );
};

export default LoginWithPassword;
