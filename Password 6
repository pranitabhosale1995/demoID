import React, { useEffect, useState } from "react";
import axios from "axios";
import { Box, InputAdornment, IconButton } from "@mui/material";
import LockIcon from "@mui/icons-material/Lock";
import Visibility from "@mui/icons-material/Visibility";
import VisibilityOff from "@mui/icons-material/VisibilityOff";
import { v4 as uuidv4 } from "uuid";

import { parseJwt } from "../../../utils/EncryptionUtilities";
import { loginDialogMessages, loginDialogHeaders } from "../constants";
import { useNavigate } from "react-router-dom";
import { useDispatch, useSelector } from "react-redux";
import { setMenus, setSelectedMenuItem } from "../../../app/slices/menuSlice";
import { setTabId } from "../../../app/slices/tabsSlice";
import { setToken, setUser } from "../../../app/slices/authSlice";

import {
  StyledTextField,
  PrimaryButton,
  FormTitle,
  PasswordErrorText,
} from "./LoginStyles";

/**
 * Props:
 *  - userId: string
 *  - openLoginErrorDialog: function (heading, content)
 *  - onBackToHome?: optional callback
 *  - content?: optional object (if parent already fetched JSON)
 */
const LoginWithPassword = ({ userId, openLoginErrorDialog, onBackToHome, content: parentContent }) => {
  const [password, setPassword] = useState("");
  const [passwordInvalidMessage, setPasswordInvalidMessage] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [content, setContent] = useState(parentContent || null);
  const [loadingContent, setLoadingContent] = useState(false);

  const navigate = useNavigate();
  const dispatch = useDispatch();
  const menus = useSelector((state) => state.menus.menus);

  // if parent passes content prop, use it; otherwise fetch the JSON.
  useEffect(() => {
    if (parentContent) return;
    let cancelled = false;
    (async () => {
      setLoadingContent(true);
      try {
        const resp = await axios.get("/content/loginContent.json");
        if (!cancelled) setContent(resp.data || null);
      } catch (e) {
        console.warn("Could not load content JSON for LoginWithPassword:", e);
        if (!cancelled) setContent(null);
      } finally {
        if (!cancelled) setLoadingContent(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [parentContent]);

  // helper to get text from content with fallback
  const t = (path, fallback) => {
    const src = content || parentContent;
    if (!src) return fallback;
    const parts = path.split(".");
    let cur = src;
    for (const p of parts) {
      if (cur == null) return fallback;
      cur = cur[p];
    }
    return cur ?? fallback;
  };

  // redirect if menus set (legacy behavior)
  useEffect(() => {
    if (menus?.[0]?.route) {
      navigate(menus[0].route);
    }
  }, [menus, navigate]);

  const validateUserCredentials = async () => {
    setPasswordInvalidMessage("");
    try {
      const response = await axios.post("/LS/auth/login", {
        userId,
        password,
      });

      const result = response?.data || {};

      if (result.validCredentials === true) {
        const user = parseJwt(result.accessToken);
        const tabId = uuidv4();

        dispatch(setTabId(tabId));
        dispatch(setToken(result.accessToken));
        dispatch(setUser(user));

        dispatch(setMenus(result.roleData?.root_menus || []));
        dispatch(setSelectedMenuItem(result.roleData?.root_menus?.[0] || null));

        try {
          const bc = new BroadcastChannel("auth");
          setTimeout(() => {
            bc.postMessage({
              type: "USER_LOGGED_IN",
              tabId,
              userId: user.userId,
            });
          }, 1000);
        } catch (e) {
          /* ignore */
        }

        // navigate to first menu route or fallback (parent content may provide default)
        const menusFromResp = result.roleData?.root_menus || [];
        const routeToNavigate = menusFromResp?.[0]?.route || (content?.defaults?.fallbackRoute ?? parentContent?.defaults?.fallbackRoute) || "/dashboard";
        navigate(routeToNavigate);

        return true;
      }

      if (result.userStatus === "ACTIVE" && result.loginMethod === "p") {
        if (typeof result.attemptsLeft === "number" && result.attemptsLeft > 0) {
          const template = t("form.invalidPasswordTemplate", "Invalid password. You have {attemptsLeft} attempts left.");
          setPasswordInvalidMessage(template.replace("{attemptsLeft}", String(result.attemptsLeft)));
        } else {
          openLoginErrorDialog(
            t("form.accountLockedTitle", "Account Locked"),
            t("form.accountLockedMessage", "You are out of attempts and your account has been locked.")
          );
        }
      } else {
        openLoginErrorDialog(
          loginDialogHeaders[result.userStatus] || "Login Error",
          loginDialogMessages[result.userStatus] || "Something went wrong"
        );
      }
      return false;
    } catch (e) {
      console.error("Error in login ::: ", e);
      openLoginErrorDialog(
        t("form.loginFailedTitle", "Login Failed"),
        e?.response?.data?.message || t("form.loginFailedMessage", "Failed to log into FinCore, please try again later")
      );
      return false;
    }
  };

  const toggleShowPassword = () => setShowPassword((s) => !s);

  return (
    <Box>
      <FormTitle>{t("form.enterPasswordTitle", "Enter Password")}</FormTitle>

      <StyledTextField
        fullWidth
        label={t("form.enterPasswordTitle", "Password")}
        type={showPassword ? "text" : "password"}
        placeholder={t("form.passwordPlaceholder", "Enter your password")}
        value={password}
        onChange={(e) => setPassword(e.target.value)}
        variant="outlined"
        error={passwordInvalidMessage !== ""}
        margin="normal"
        InputProps={{
          startAdornment: (
            <InputAdornment position="start">
              <LockIcon />
            </InputAdornment>
          ),
          endAdornment: (
            <InputAdornment position="end">
              <IconButton
                aria-label={showPassword ? "Hide password" : "Show password"}
                onClick={toggleShowPassword}
                edge="end"
                size="large"
              >
                {showPassword ? <VisibilityOff /> : <Visibility />}
              </IconButton>
            </InputAdornment>
          ),
        }}
      />

      {passwordInvalidMessage && (
        <PasswordErrorText>{passwordInvalidMessage}</PasswordErrorText>
      )}

      <PrimaryButton
        fullWidth
        variant="contained"
        onClick={validateUserCredentials}
        disabled={!userId}
      >
        {t("form.signInButton", "Sign In")}
      </PrimaryButton>
    </Box>
  );
};

export default LoginWithPassword;
